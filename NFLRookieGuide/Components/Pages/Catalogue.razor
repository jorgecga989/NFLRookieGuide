@page "/catalogue"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using NFLRookieGuide.Context
@using NFLRookieGuide.Model
@inject UserProvider UserProvider
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject RosterProvider RosterProvider
@attribute [Authorize]

<h1 style="font-size: 55px; text-align:center; margin-top: 50px;" class="mb-4">Your teams</h1>

@if (rosters is null)
{
    <p>Loading...</p>
}
else if (!rosters.Any())
{
    <p>No rosters have been created</p>
}
else
{
    <div style="margin-top: 75px;">
        <table class="table table-striped table-bordered" style="table-layout: fixed; width: 100%;">
            <thead style="background-color: #d3d3d3;">
                <tr>
                    <th style="min-height: 50px;">Roster Name</th>
                    @if (rosters.SelectMany(r => r.SelectedPlayers ?? Enumerable.Empty<string>()).Any())
                    {
                        var maxSlots = rosters.Max(r => r.SelectedPlayers?.Count ?? 0);
                        for (int i = 0; i < maxSlots; i++)
                        {
                            <th style="min-height: 50px;">Slot @($"{i + 1}")</th>
                        }
                    }
                    <th style="min-height:50px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var roster in rosters)
                {
                    <tr style="height: 60px;">
                        <td>@roster.Name</td>
                        @if (roster.SelectedPlayers != null)
                        {
                            for (int i = 0; i < (rosters.Max(r => r.SelectedPlayers?.Count) ?? 0); i++)
                            {
                                <td style="height: 60px; vertical-align: middle; text-align: center;">
                                    @if (i < roster.SelectedPlayers.Count && roster.SelectedPlayers[i] != null)
                                    {
                                        @roster.SelectedPlayers[i]
                                    }
                                </td>
                            }
                        }
                        <td>
                            <div class="d-flex justify-content-center">
                                <button class="btn btn-danger mt-1" @onclick="() => Delete(roster)">Delete</button>
                                <button class="btn btn-primary mt-1">Edit</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>

        </table>
    </div>
}


@code {
    private IEnumerable<Roster> rosters;

    protected override void OnInitialized()
    {
        RosterProvider.OnRosterUpdated += StateHasChanged;
    }

    protected async override Task OnInitializedAsync()
    {
        var authstate = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var username = authstate.User!.Identity!.Name!;
        var user = UserProvider.GetUserByUsername(username);

        rosters = await RosterProvider.GetRostersAsync(user!);
    }

    private void Delete(Roster roster)
    {
        RosterProvider.DeleteRoster(roster);
    }
}
